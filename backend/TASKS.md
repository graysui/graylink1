# GrayLink 后端修复任务清单

## ⚠️ 重要提示：目录完整性检查

在开始任何修改之前，必须完成以下目录检查清单：

```
backend/app/
├── core/      [✓] 核心功能模块
│   ├── base.py        ✓
│   ├── database.py    ✓
│   ├── session.py     ✓
│   ├── config.py      ⬅️ 当前任务
│   ├── cache.py       
│   └── security.py    
│
├── handlers/  [ ] API 处理器
│   ├── auth.py
│   ├── monitor.py
│   └── ...
│
├── models/    [✓] 数据模型
│   ├── user.py
│   └── ...
│
├── modules/   [✓] 核心业务逻辑
│   ├── monitor/   ✓ 监控模块
│   │   ├── models.py
│   │   ├── scanner.py
│   │   ├── service.py
│   │   └── events.py
│   ├── symlink/   ✓ 软链接模块
│   │   └── manager.py
│   ├── emby/      - Emby集成
│   │   ├── client.py
│   │   └── service.py
│   └── database/  ✓ 数据库管理
│       └── manager.py
│
├── schemas/   [ ] 数据验证
│
└── utils/     [ ] 工具函数
```

### 目录检查要求

1. 每次修改前：
   - [✓] 完整遍历所有目录
   - [✓] 特别关注 modules 目录
   - [✓] 检查模块间的依赖关系

2. 修改时注意：
   - [✓] 确保修改不影响 modules 中的业务逻辑
   - [✓] 验证所有相关模块的功能
   - [✓] 保持模块间接口的一致性

3. 修改后确认：
   - [✓] 重新检查所有目录
   - [✓] 验证业务模块的完整性
   - [✓] 测试模块间的交互

## 1. 数据库基础设施重构

### 1.1 SQLAlchemy Base 类重构 ✓
- [x] 创建新的 `app/core/base.py` 文件
  - [x] 定义 SQLAlchemy 声明性基类
  - [x] 添加必要的导入
  - [x] 添加通用的模型方法和属性
- [x] 修改 `app/core/database.py`
  - [x] 移除循环导入
  - [x] 优化数据库连接配置
  - [x] 添加连接池监控
  - [x] 确保与 modules/database/manager.py 兼容
- [x] 更新 `app/models/user.py`
  - [x] 修改 Base 导入路径
  - [x] 优化模型定义
  - [x] 添加模型验证

### 1.2 模块依赖重组 ✓
- [x] 重构 models 包
  - [x] 更新 `__init__.py` 导出
  - [x] 移除循环导入
  - [x] 优化导入顺序
  - [x] 确保与 modules/monitor/models.py 兼容
- [x] 重构 handlers 包
  - [x] 更新认证处理器导入
  - [x] 优化依赖注入
  - [x] 确保正确的导入顺序

### 1.3 数据库会话管理优化 ✓
- [x] 优化会话工厂
  - [x] 实现会话生命周期管理
  - [x] 添加会话清理机制
  - [x] 实现连接池监控
  - [x] 与 modules/database/manager.py 集成
- [x] 改进依赖注入
  - [x] 优化 get_db 依赖
  - [x] 添加事务管理
  - [x] 实现会话复用

## 2. 项目结构优化 ✓

### 2.1 核心模块重组（优先级：高） ✓
- [x] 优化 core 包结构
  ```
  core/
  ├── __init__.py
  ├── base.py        ✓ SQLAlchemy 基类定义
  ├── database.py    ✓ 数据库连接管理
  ├── session.py     ✓ 会话管理
  ├── config.py      ✓ 配置管理
  ├── cache.py       ✓ 缓存管理
  └── security.py    ✓ 安全相关
  ```
- [x] 明确模块职责
- [x] 建立清晰的依赖关系

### 2.2 业务模块优化（优先级：高）
- [x] Monitor 模块
  - [x] 确保 models.py 使用正确的 Base 类
  - [x] 验证 scanner.py 的文件扫描功能
  - [x] 检查 service.py 的监控服务
  - [x] 确保 events.py 的事件处理正常
  - [x] 验证 gdrive.py 的 Google Drive 集成
- [x] Symlink 模块
  - [x] 检查 manager.py 的软链接管理功能
  - [x] 验证与文件系统的交互
  - [x] 添加备份和恢复功能
  - [x] 实现性能监控和统计
  - [x] 优化错误处理和日志记录
- [x] Emby 模块
  - [x] 确保 client.py 的 API 调用正常
  - [x] 验证 service.py 的服务功能
  - [x] 添加错误重试机制
  - [x] 实现性能监控
  - [x] 优化媒体库刷新逻辑
- [x] Database 模块
  - [x] 优化 manager.py 的数据库管理功能
  - [x] 确保与新的数据库基础设施兼容

### 2.3 导入路径规范化（优先级：中）
- [x] 统一导入风格
  - [x] 使用绝对导入
  - [x] 避免循环依赖
  - [x] 规范导入顺序
- [x] 更新所有相关文件的导入语句
- [x] 添加导入检查工具配置

### 2.4 文档更新（优先级：低） ✓
- [x] 更新项目结构文档
- [x] 添加数据库配置说明
- [x] 更新开发指南
- [x] 添加模块交互说明

## 3. 代码质量提升 ⬅️ 当前阶段

### 3.1 类型注解完善 ⬅️ 当前任务
- [ ] 添加 SQLAlchemy 模型类型注解
- [ ] 完善函数参数类型提示
- [ ] 添加返回值类型注解
- [ ] 补充业务模块的类型注解

### 3.2 错误处理增强
- [ ] 实现统一的错误处理机制
- [ ] 添加数据库异常处理
- [ ] 完善错误日志记录
- [ ] 优化业务模块的错误处理

### 3.3 测试用例补充
- [ ] 添加数据库模型测试
- [ ] 添加会话管理测试
- [ ] 补充集成测试
- [ ] 添加业务模块测试
  - [ ] Monitor 模块测试
  - [ ] Symlink 模块测试
  - [ ] Emby 模块测试
  - [ ] Database 模块测试

## 4. 性能优化

### 4.1 数据库性能
- [ ] 优化连接池配置
- [ ] 添加查询性能监控
- [ ] 实现查询缓存机制
- [ ] 优化数据库管理器性能

### 4.2 并发处理
- [ ] 优化异步数据库操作
- [ ] 添加并发限制
- [ ] 实现请求队列
- [ ] 优化模块间的并发操作

## 注意事项

1. 前后端兼容性
   - 确保所有修改不影响前端接口
   - 保持 API 响应格式不变
   - 维持现有的 API 路由和参数
   - 不要要求前端做任何修改

2. 功能完整性
   - 保持所有现有功能的完整性
   - 不随意删除任何功能代码
   - 修改前确保完全理解代码作用
   - 记录所有功能点确保全部保留

3. 代码依赖管理
   - 删除代码前全面评估影响范围
   - 检查代码间的调用关系
   - 确保相关模块的功能正常
   - 维护必要的代码注释

4. 整体性原则
   - 以整个后端为整体考虑修改
   - 同步修改所有相关联模块
   - 确保修改后系统可以完整运行
   - 避免孤立修改单个模块

5. 代码修改原则
   - 保持向后兼容
   - 最小化修改范围
   - 确保测试覆盖

6. 依赖处理
   - 避免循环导入
   - 明确模块职责

7. 测试要求
   - 每个修改都需要测试
   - 确保不破坏现有功能
   - 验证性能影响

8. 文档维护
   - 及时更新文档
   - 添加注释说明
   - 记录重要决策

## 修改核查清单

### 1. 修改前评估
- [ ] 完整理解当前功能
- [ ] 识别所有相关模块
- [ ] 评估对前端的影响
- [ ] 确定最小修改范围

### 2. 修改中检查
- [ ] 确保修改的完整性
- [ ] 验证相关模块的同步修改
- [ ] 保持代码注释的更新
- [ ] 进行单元测试

### 3. 修改后验证
- [ ] 验证所有功能完整性
- [ ] 确认前端接口正常
- [ ] 检查系统整体运行状态
- [ ] 完成文档更新

## 优先级任务

1. 立即修复
   - 创建 Base 类定义
   - 修复循环导入
   - 更新模型导入
   - 确保业务模块兼容

2. 后续优化
   - 完善错误处理
   - 添加性能监控
   - 补充测试用例
   - 优化模块性能 

## 下一步任务

1. 类型注解完善
   - [ ] 检查并添加 SQLAlchemy 模型类型注解
   - [ ] 完善所有函数的参数类型提示
   - [ ] 添加返回值类型注解
   - [ ] 补充业务模块的类型注解

2. 错误处理增强
   - [ ] 实现统一的错误处理机制
   - [ ] 完善异常处理流程
   - [ ] 优化错误日志记录

3. 测试用例补充
   - [ ] 添加单元测试
   - [ ] 补充集成测试
   - [ ] 实现性能测试

## 当前阶段完成情况
- [x] 数据库基础设施重构
- [x] 项目结构优化 ✓
  - [x] 核心模块重组
  - [x] Monitor 模块优化
  - [x] Symlink 模块优化
  - [x] Emby 模块优化
  - [x] 导入路径规范化
  - [x] 文档更新
- [ ] 代码质量提升 ⬅️ 进行中
  - [ ] 类型注解完善 ⬅️ 当前任务
  - [ ] 错误处理增强
  - [ ] 测试用例补充
- [ ] 性能优化 